name: Update Preview Image from PDF

on:
  push:
    branches: [main]
    paths:
      - "Harsh_Singh_Software_Engineer_Resume.pdf"
      - "convert_pdf_to_image.py"
  workflow_dispatch:
    inputs:
      force_update:
        description: "Force update preview image"
        required: false
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  update-preview-image:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y poppler-utils

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pdf2image Pillow

      - name: Check if PDF exists
        run: |
          if [ ! -f "Harsh_Singh_Software_Engineer_Resume.pdf" ]; then
            echo "❌ PDF file not found!"
            exit 1
          fi
          echo "✅ PDF file found"

      - name: Convert PDF to preview image
        run: |
          python convert_pdf_to_image.py --dpi 300

      - name: Verify image was created
        run: |
          if [ ! -f "Harsh_Singh_Software_Engineer_Resume.png" ]; then
            echo "❌ Preview image was not created!"
            exit 1
          fi
          echo "✅ Preview image created successfully"
          ls -la Harsh_Singh_Software_Engineer_Resume.png

      - name: Optimize image size
        run: |
          # Install additional tools for optimization
          sudo apt-get install -y pngquant optipng

          # Create backup
          cp Harsh_Singh_Software_Engineer_Resume.png Harsh_Singh_Software_Engineer_Resume_original.png

          # Optimize PNG
          pngquant --quality=80-95 --ext .png --force Harsh_Singh_Software_Engineer_Resume.png
          optipng -o2 Harsh_Singh_Software_Engineer_Resume.png

          echo "📊 Original size: $(stat -c%s Harsh_Singh_Software_Engineer_Resume_original.png) bytes"
          echo "📊 Optimized size: $(stat -c%s Harsh_Singh_Software_Engineer_Resume.png) bytes"

          # Clean up backup
          rm Harsh_Singh_Software_Engineer_Resume_original.png

      - name: Check for changes
        id: git-check
        run: |
          git diff --exit-code Harsh_Singh_Software_Engineer_Resume.png || echo "changes=true" >> $GITHUB_OUTPUT

      - name: Commit and push changes
        if: steps.git-check.outputs.changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add Harsh_Singh_Software_Engineer_Resume.png
          git commit -m "🖼️ Auto-update resume preview image from PDF

          - Generated from: Harsh_Singh_Software_Engineer_Resume.pdf
          - Resolution: 300 DPI
          - Optimized for social media sharing
          - Auto-generated by GitHub Actions"
          git push

      - name: Summary
        run: |
          echo "🎉 Preview image update completed!"
          echo ""
          echo "📊 Image info:"
          echo "   Size: $(stat -c%s Harsh_Singh_Software_Engineer_Resume.png) bytes"
          echo "   Dimensions: $(identify -format '%wx%h' Harsh_Singh_Software_Engineer_Resume.png)"
          echo ""
          echo "🔗 The updated preview image will be used for:"
          echo "   - Social media sharing (Facebook, Twitter, LinkedIn)"
          echo "   - Link previews in messaging apps"
          echo "   - Search engine results"
          echo ""
          echo "✅ Your website will now show the updated preview image!"

  # Job to trigger main site deployment after image update
  trigger-deployment:
    needs: update-preview-image
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: Trigger main deployment
        run: |
          echo "🚀 Preview image updated, main deployment will be triggered automatically"
          echo "   by the existing deploy workflow when changes are pushed."
